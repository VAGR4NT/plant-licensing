{% extends "main/base.html" %}
{% load static %}

{% block title %} View {% endblock %}

{% block page_css %}
  <link rel="stylesheet" href="{% static 'css/specific-view.css' %}" />
{% endblock %}

{% block content %}

{{ table_fields|json_script:"table-fields-data" }}
<form method="get" class="searchForm" action="">
  <fieldset class="search-area">
    <legend>Search Options</legend>

    <div class="search-and-filters">
      
      <div class="search-block">
        <input
          class="search-bar"
          type="text"
          name="q"
          placeholder="Enter Business Name, Contact, Address, etc..."
          value="{{ request_get.q|default:'' }}"
        >
      </div>

      <details class="advanced-filters" open>
        <summary>Advanced Filters</summary>
        <div class="filter-content">
          <div id="filter-list-container"></div>
          <button type="button" id="add-filter-btn">+ Add Filter</button>
        </div>
      </details>
    </div>
  </fieldset>

  <fieldset class="basic-filter-form">
    <legend>Select Columns to Display</legend>

    <div class="carousel-indicators">
      <span class="dot active"></span>
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
    </div>

    <div class="column_container">
      {% for table, fields in table_fields.items %}
      <div class="column_box">
        <h3>{{ table }}</h3>

        <div class="checkbox-wrapper {% if fields|length > 10 %}multi-column{% endif %}">
          {% for field_name in fields %}
          <label>
            <input
              type="checkbox"
              name="columns"
              value="{{ field_name.name }}"
              {% if field_name.name in checked_columns %}checked{% endif %}
            >
            {{ field_name.label|title }}
          </label>
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
  </fieldset>

  <button type="submit" id="reportBtn" class="btn">Generate Report</button>
</form>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector(".searchForm");
    if (!form) return;

    form.addEventListener("submit", function () {
      form.action = form.action.split("#")[0] + "#results";
    });
  });
</script>

<section id="results" class="results-section">
  <h2>Results</h2>
  {% if error_message %}
    <p style="color: red;">{{ error_message }}</p>
  {% elif result_count is not None %}
    <p>Found {{ result_count }} matching record(s). Showing {{ rows|length }}.</p>
    {% if rows %}
    <div class="datatable-container">
      <table class="datatable">
        <thead>
          <tr>
            <th>Actions</th>
            {% for header in headers %}
              <th>{{ header }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in rows %}
          <tr>
            <td>
               <a class="btn" href="{% url 'update' business_model_id row.id %}">Edit</a>
            </td>
            {% for cell in row.data %}
              <td>{{ cell }}</td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
  {% else %}
    <p>No query submitted yet. Please generate a report.</p>
  {% endif %}
</section>

{% endblock %}

{% block page_js %}

<script src="{% static 'js/view/specific_view_filter.js' %}"></script>
<script src="{% static 'js/view/specific_view_carousel.js' %}"></script>

{% endblock %}

