{% extends "main/base.html" %}
{% load static %}

{% block title %} Nursery License Renewal {% endblock %}

{% block page_css %}
  <link rel="stylesheet" href="{% static 'main/css/nursery_generate.css' %}">
{% endblock %}

{% block content %}

<h1>Nursery License Renewal</h1>
<a href="{% url 'dealer_generate' %}" id="dealer-btn" class="btn">Generate Dealer Licenses</a>
<a href="{% url 'pdf_update' %}" id="renewal-btn" class="btn">Update License Template PDFs</a>
<hr>

<div class="form-container">
  <h2>Nursery Email Template</h2>

  <form class="form-section" method="POST">
      {% csrf_token %}

      <div class="form-field">
        <label for="subject">Subject</label>
        <input
            id="subject"
            type="text"
            name="subject"
            value="{{ template.subject }}"
            placeholder="Email Subject"
        >
      </div>

      <div class="form-field">
        <label for="body">Email Body</label>
        <textarea id="body" name="body">{{ template.body }}</textarea>
      </div>

      <div class="form-controls">
          <button type="submit" class="btn primary" id="save-button">
            Save Template Changes
          </button>
      </div>
  </form>
</div>

<div class="renewal-section-wrapper">
  <h2 class="renewal-section-title">License Renewals</h2>

  <div class="toggle-view">
      {% if show_wants %}
          <a class="btn secondary" href="?show_wants=0">Display - Email: False</a>
      {% else %}
          <a class="btn secondary" href="?show_wants=1">Display - Email: True</a>
      {% endif %}
  </div>

</div>


{% for b in businesses %}
<div class="business-card">

    <div class="business-header">
        {{ b.business_name }} â€” Renewal Email:
        <span style="font-weight: normal;">{{ b.wants_email_renewal }}</span>
    </div>

<div class="actions">

    <!-- Download Email -->
    <a class="btn secondary"
       href="{% url 'download_eml' 'nursery' b.business_id %}">
        Download Email (.eml)
    </a>
    <!-- Download PDF -->
    <a 
        class="btn secondary"
        href="{% url 'download_pdf' 'nursery' b.business_id %}"
    >
        Download PDF
    </a>

        <!-- Download Nursery PDF -->
        <a
          class="btn secondary"
          href="{% url 'download_pdf' 'nursery' b.business_id %}"
          >
          Download PDF
        </a>
      
        <!-- Unified PDF Preview -->
        <button 
            class="btn preview-btn"
            onclick="togglePreview(this)"
            data-biz="{{ b.business_id }}"
            data-preview-url="{% url 'preview_pdf' 'nursery' b.business_id %}"
        >
            Show PDF
        </button>


</div>

    <div id="preview-{{ b.business_id }}" class="preview-container">

        <!-- Loading indicator -->
        <div class="loading-indicator" id="loading-{{ b.business_id }}">
            <div class="loading-spinner"></div>
            <div>Loading PDF preview...</div>
        </div>

        <!-- Status messages -->
        <div class="preview-status" id="status-{{ b.business_id }}" style="display: none;"></div>

        <!-- PDF iframe -->
        <iframe
            id="iframe-{{ b.business_id }}"
            class="preview-frame"
            data-preview-url="{% url 'preview_pdf' 'nursery' b.business_id %}"
            src="about:blank"
            onload="onIframeLoad(this)"
            onerror="onIframeError(this)"
        ></iframe>
    </div>

</div>
{% empty %}
<p>No businesses found.</p>
{% endfor %}

{% endblock %}

{% block page_js %}
  <script src="{% static 'main/js/generate-forms/pdf-preview.js' %}"></script>
{% endblock %}


