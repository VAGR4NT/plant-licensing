{% extends "main/base.html" %}

{% block title %} Update {% endblock %} {% block content %}

<div class="container">

    <form class-="form-section" method="POST">
        {% csrf_token %}
        <h2>Details for: {{ master_object }}</h2>
       
        <div class="form-controls">
            <button type="button" id="edit-button">Edit</button>
            <button type="submit" id="save-button">Save Changes</button>
            <button type="button" id="cancel-button">Cancel</button>
        </div> 

        <fieldset id="master-form-fieldset" disabled>
            {% for field in form %}
                <div class="form-field">
                    {{ field.label_tag }}
                    {{ field }}
                    {% if field.help_text %}<small>{{ field.help_text }}</small>{% endif %}
                    {% for error in field.errors %}<p style="color: red;">{{ error }}</p>{% endfor %}
                </div>
            {% endfor %}
        </fieldset>

    </form>

    {% for section_name, info in related_sections.items %}
    <div class="child-section">
        <h3>{{ section_name }}</h3>
        
        {% if info.items %}
        <table class="child-table">
            <thead>
                <tr>
                    <th>Name / Identifier</th> 
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in info.items %}
                <tr>
                    <td>{{ item }}</td> <td>
                        <div class="child-table-actions">
                            <a href="{% url 'update' model=info.model pk=item.pk %}">Edit</a> <form method="POST" action="#"> {% csrf_token %}
                                <input type="hidden" name="item_to_delete" value="{{ item.pk }}">
                                <button type="submit" style="color: red; background: none; border: none; padding: 0; cursor: pointer;">Remove</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p>No {{ section_name }} found for this item.</p>
        {% endif %}

    {% endfor %}

</div>

<script>
    // This waits for the whole page to be loaded before running the script
    document.addEventListener('DOMContentLoaded', (event) => {
        
        // 1. Get references to the elements we need to control
        const fieldset = document.getElementById('master-form-fieldset');
        const editButton = document.getElementById('edit-button');
        const saveButton = document.getElementById('save-button');
        const cancelButton = document.getElementById('cancel-button');

        // 2. Listen for a click on the "Edit" button
        editButton.addEventListener('click', () => {
            // Enable the form fields
            fieldset.disabled = false;
            
            // Toggle the button visibility
            editButton.style.display = 'none';
            saveButton.style.display = 'inline-block';
            cancelButton.style.display = 'inline-block';
        });

        // 3. Listen for a click on the "Cancel" button
        cancelButton.addEventListener('click', () => {
            // Disable the form fields again
            fieldset.disabled = true;

            // Toggle the button visibility back to the start
            editButton.style.display = 'inline-block';
            saveButton.style.display = 'none';
            cancelButton.style.display = 'none';

            // Optional: You could add logic here to reset form fields 
            // to their original values if the user made changes
            // but for now, it just locks the form.
        });
    });
</script>

{% endblock %}
